

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>examples &mdash; lupyne 2.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="server" href="server.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> lupyne
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="engine.html">engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="server.html">server</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#indexers">indexers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lucene">lucene</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lupyne">lupyne</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#queries">queries</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lucene">lucene</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lupyne">lupyne</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#searching">searching</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sorting">sorting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lucene">lucene</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lupyne">lupyne</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#grouping">grouping</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">lupyne</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>examples</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/examples.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="examples">
<h1>examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h1>
<div class="section" id="indexers">
<h2>indexers<a class="headerlink" href="#indexers" title="Permalink to this headline">¶</a></h2>
<p>Basic indexing and searching adapted from <a class="reference external" href="http://lucene.apache.org/core/8_1_1/core/index.html">lucene’s documentation</a>.</p>
<div class="section" id="lucene">
<h3>lucene<a class="headerlink" href="#lucene" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">lucene</span>
<span class="kn">from</span> <span class="nn">org.apache.lucene</span> <span class="kn">import</span> <span class="n">analysis</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">queryparser</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">store</span>
<span class="kn">from</span> <span class="nn">lupyne</span> <span class="kn">import</span> <span class="n">engine</span>

<span class="k">assert</span> <span class="n">lucene</span><span class="o">.</span><span class="n">getVMEnv</span><span class="p">()</span> <span class="ow">or</span> <span class="n">lucene</span><span class="o">.</span><span class="n">initVM</span><span class="p">()</span>

<span class="n">analyzer</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">standard</span><span class="o">.</span><span class="n">StandardAnalyzer</span><span class="p">()</span>

<span class="n">directory</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">RAMDirectory</span><span class="p">()</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">IndexWriterConfig</span><span class="p">(</span><span class="n">analyzer</span><span class="p">)</span>
<span class="n">iwriter</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">IndexWriter</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<span class="n">doc</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">Document</span><span class="p">()</span>
<span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;This is the text to be indexed.&quot;</span>
<span class="n">doc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="s1">&#39;fieldname&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">document</span><span class="o">.</span><span class="n">TextField</span><span class="o">.</span><span class="n">TYPE_STORED</span><span class="p">))</span>
<span class="n">iwriter</span><span class="o">.</span><span class="n">addDocument</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
<span class="n">iwriter</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Now search the index:</span>
<span class="n">ireader</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">DirectoryReader</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
<span class="n">isearcher</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">IndexSearcher</span><span class="p">(</span><span class="n">ireader</span><span class="p">)</span>
<span class="c1"># Parse a simple query that searches for &quot;text&quot;:</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">queryparser</span><span class="o">.</span><span class="n">classic</span><span class="o">.</span><span class="n">QueryParser</span><span class="p">(</span><span class="s1">&#39;fieldname&#39;</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">)</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
<span class="n">hits</span> <span class="o">=</span> <span class="n">isearcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">scoreDocs</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="c1"># Iterate through the results:</span>
<span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
    <span class="n">hitDoc</span> <span class="o">=</span> <span class="n">isearcher</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">doc</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">hitDoc</span><span class="p">[</span><span class="s1">&#39;fieldname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">text</span>
<span class="n">ireader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">directory</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="lupyne">
<h3>lupyne<a class="headerlink" href="#lupyne" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">indexer</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">Indexer</span><span class="p">()</span>  <span class="c1"># Indexer combines Writer and Searcher; RAMDirectory and StandardAnalyzer are defaults</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;fieldname&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">Field</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">stored</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># default indexed text settings for documents</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fieldname</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># add document</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># commit changes and refresh searcher</span>

<span class="n">hits</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s1">&#39;fieldname&#39;</span><span class="p">)</span>  <span class="c1"># parsing handled if necessary</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>  <span class="c1"># hits support mapping interface</span>
    <span class="k">assert</span> <span class="n">hit</span><span class="p">[</span><span class="s1">&#39;fieldname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">text</span>
<span class="c1"># closing is handled automatically</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="queries">
<h2>queries<a class="headerlink" href="#queries" title="Permalink to this headline">¶</a></h2>
<p>Operator overloading is used for combining boolean clauses.</p>
<div class="section" id="lucene">
<h3>lucene<a class="headerlink" href="#lucene" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">org.apache.lucene.search</span> <span class="kn">import</span> <span class="n">spans</span>

<span class="n">q1</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">TermQuery</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">Term</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;lucene&#39;</span><span class="p">))</span>
<span class="n">q2</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">PhraseQuery</span><span class="o">.</span><span class="n">Builder</span><span class="p">()</span> \
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">Term</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">Term</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;engine&#39;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="n">search</span><span class="o">.</span><span class="n">BooleanQuery</span><span class="o">.</span><span class="n">Builder</span><span class="p">()</span> \
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">search</span><span class="o">.</span><span class="n">BooleanClause</span><span class="o">.</span><span class="n">Occur</span><span class="o">.</span><span class="n">MUST</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span> <span class="n">search</span><span class="o">.</span><span class="n">BooleanClause</span><span class="o">.</span><span class="n">Occur</span><span class="o">.</span><span class="n">MUST</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;BooleanQuery: +text:lucene +text:&quot;search engine&quot;&gt;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">q1</span> <span class="o">=</span> <span class="n">spans</span><span class="o">.</span><span class="n">SpanTermQuery</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">Term</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">))</span>
<span class="n">q2</span> <span class="o">=</span> <span class="n">spans</span><span class="o">.</span><span class="n">SpanTermQuery</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">Term</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">))</span>
<span class="n">q3</span> <span class="o">=</span> <span class="n">spans</span><span class="o">.</span><span class="n">SpanPositionRangeQuery</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">q4</span> <span class="o">=</span> <span class="n">spans</span><span class="o">.</span><span class="n">SpanNearQuery</span><span class="p">([</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">spans</span><span class="o">.</span><span class="n">SpanNotQuery</span><span class="p">(</span><span class="n">q3</span><span class="p">,</span> <span class="n">q4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;SpanNotQuery: spanNot(spanPosRange(text:hello, 0, 10), spanNear([text:hello, text:world], 0, true), 0, 0)&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="lupyne">
<h3>lupyne<a class="headerlink" href="#lupyne" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Q</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">Query</span>

<span class="n">Q</span><span class="o">.</span><span class="n">term</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;lucene&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Q</span><span class="o">.</span><span class="n">phrase</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;engine&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;BooleanQuery: +text:lucene +text:&quot;search engine&quot;&gt;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Q</span><span class="o">.</span><span class="n">span</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">-</span> <span class="n">Q</span><span class="o">.</span><span class="n">near</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;SpanNotQuery: spanNot(spanPosRange(text:hello, 0, 10), spanNear([text:hello, text:world], 0, true), 0, 0)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="searching">
<h2>searching<a class="headerlink" href="#searching" title="Permalink to this headline">¶</a></h2>
<p>Advanced searching with custom fields.</p>
<p>Lupyne SpatialFields and DateTimeFields are implemented as lucene Point fields. NestedFields simulate a composite index. The fields have convenience methods for creating prefix and range queries.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="n">docs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span> <span class="s1">&#39;San Francisco&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;incorporated&#39;</span><span class="p">:</span> <span class="s1">&#39;1850-04-15&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">:</span> <span class="mi">808976</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">122.4192</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">37.7752</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span> <span class="s1">&#39;Los Angeles&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;incorporated&#39;</span><span class="p">:</span> <span class="s1">&#39;1850-04-04&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">:</span> <span class="mi">3849378</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">118.2434</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">34.0521</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span> <span class="s1">&#39;Portland&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;OR&#39;</span><span class="p">,</span> <span class="s1">&#39;incorporated&#39;</span><span class="p">:</span> <span class="s1">&#39;1851-02-08&#39;</span><span class="p">,</span> <span class="s1">&#39;population&#39;</span><span class="p">:</span> <span class="mi">575930</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">122.6703</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mf">45.5238</span><span class="p">},</span>
<span class="p">]</span>

<span class="n">indexer</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">Indexer</span><span class="p">()</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="n">stored</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="n">stored</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># set method supports custom field types inheriting their default settings</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;incorporated&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">)</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;year-month-day&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">NestedField</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;point&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">SpatialField</span><span class="p">)</span>
<span class="c1"># assigned fields can have a different key from their underlying field name</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">NestedField</span><span class="p">(</span><span class="s1">&#39;state.city&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
    <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;year-month-day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;incorporated&#39;</span><span class="p">]</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">),</span> <span class="n">doc</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">)</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span>
    <span class="n">incorporated</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;incorporated&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
    <span class="n">indexer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">incorporated</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="o">*</span><span class="n">incorporated</span><span class="p">),</span> <span class="n">point</span><span class="o">=</span><span class="p">[</span><span class="n">point</span><span class="p">])</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="n">query</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;incorporated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">([</span><span class="mi">1850</span><span class="p">])</span>
<span class="p">[</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;San Francisco&#39;, &#39;Los Angeles&#39;]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">query</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;incorporated&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">1850</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
<span class="p">[</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;San Francisco&#39;, &#39;Portland&#39;]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">query</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;year-month-day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">(</span><span class="s1">&#39;1850&#39;</span><span class="p">)</span>
<span class="n">query</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;PrefixQuery: year:1850*&gt;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="p">[</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;San Francisco&#39;, &#39;Los Angeles&#39;]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">query</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;year-month-day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="s1">&#39;1850-04-10&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">query</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;TermRangeQuery: year-month-day:[1850-04-10 TO *}&gt;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="p">[</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;San Francisco&#39;, &#39;Portland&#39;]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">query</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">ranges</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">))</span>
<span class="p">[</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;San Francisco&#39;, &#39;Portland&#39;]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cities</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;San Francisco&#39;</span><span class="p">,</span> <span class="s1">&#39;Los Angeles&#39;</span><span class="p">,</span> <span class="s1">&#39;Portland&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">distance</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">1e3</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">,</span> <span class="mf">7e5</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">]):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;point&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="o">-</span><span class="mf">122.4</span><span class="p">,</span> <span class="mf">37.7</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">([</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[]
[&#39;San Francisco&#39;]
[&#39;San Francisco&#39;, &#39;Los Angeles&#39;]
[&#39;San Francisco&#39;, &#39;Los Angeles&#39;, &#39;Portland&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">query</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">(</span><span class="s1">&#39;CA.San&#39;</span><span class="p">)</span>
<span class="n">query</span>  <span class="c1"># works like any prefix query</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;PrefixQuery: state.city:CA.San*&gt;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="p">[</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;San Francisco&#39;]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">query</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prefix</span><span class="p">(</span><span class="s1">&#39;CA&#39;</span><span class="p">)</span>
<span class="n">query</span>  <span class="c1"># optimized to search the best field</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;PrefixQuery: state:CA*&gt;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="p">[</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;San Francisco&#39;, &#39;Los Angeles&#39;]
</pre></div>
</div>
</div>
</div>
<div class="section" id="sorting">
<h2>sorting<a class="headerlink" href="#sorting" title="Permalink to this headline">¶</a></h2>
<p>PyLucene has several pitfalls when collecting or sorting a large query result. Generally they involve the overhead of traversing the VM in an internal loop.</p>
<p>Lucene also requires supplying a maximum doc count for searches, and supplying an excessively large count is a poor workaround because the collection heap is pre-allocated.</p>
<p>To mitigate these problems, Lupyne first provides a unified search interface. The same Hits type is returned regardless of optional doc count or sorting parameters. As with lucene, the result is fully evaluated but each individual Hit object will only be loaded on demand. Internally a CachingCollector is used when all docs are requested.</p>
<p>The search method allows lucene Sort parameters to be passed through, since that’s still optimal. Additionally the hits themselves can be sorted afterwards with any python callable key. The IndexReader.docvalues method is convenient for creating a sort key table from fields with docvalues. The upshot is custom sorting and sorting large results are both easier and faster.</p>
<p>Custom sorting isn’t necessary in the below example of course, just there for demonstration.</p>
<div class="section" id="lucene">
<h3>lucene<a class="headerlink" href="#lucene" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">colors</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span>
<span class="n">indexer</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">Indexer</span><span class="p">()</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">Field</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">stored</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">docValuesType</span><span class="o">=</span><span class="s1">&#39;sorted&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
    <span class="n">indexer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="n">searcher</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">IndexSearcher</span><span class="p">(</span><span class="n">indexer</span><span class="o">.</span><span class="n">indexReader</span><span class="p">)</span>
<span class="n">sorter</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">SortField</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">search</span><span class="o">.</span><span class="n">SortField</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">STRING</span><span class="p">))</span>
<span class="n">topdocs</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">MatchAllDocsQuery</span><span class="p">(),</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sorter</span><span class="p">)</span>
<span class="p">[</span><span class="n">searcher</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="n">scoredoc</span><span class="o">.</span><span class="n">doc</span><span class="p">)[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">scoredoc</span> <span class="ow">in</span> <span class="n">topdocs</span><span class="o">.</span><span class="n">scoreDocs</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;blue&#39;, &#39;cyan&#39;, &#39;green&#39;, &#39;magenta&#39;, &#39;red&#39;, &#39;yellow&#39;]
</pre></div>
</div>
</div>
</div>
<div class="section" id="lupyne">
<h3>lupyne<a class="headerlink" href="#lupyne" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hits</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">)</span>
<span class="p">[</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;blue&#39;, &#39;cyan&#39;, &#39;green&#39;, &#39;magenta&#39;, &#39;red&#39;, &#39;yellow&#39;]
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">docvalues</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="n">docvalues</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">)</span>
<span class="n">docvalues</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>{0: &#39;red&#39;, 1: &#39;green&#39;, 2: &#39;blue&#39;, 3: &#39;cyan&#39;, 4: &#39;magenta&#39;, 5: &#39;yellow&#39;}
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hits</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">()</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">docvalues</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)</span>
<span class="p">[</span><span class="n">hit</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;blue&#39;, &#39;cyan&#39;, &#39;green&#39;, &#39;magenta&#39;, &#39;red&#39;, &#39;yellow&#39;]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="grouping">
<h2>grouping<a class="headerlink" href="#grouping" title="Permalink to this headline">¶</a></h2>
<p>Lupyne supports lucene’s contrib grouping.GroupingSearch interface, but it has some limitations. GroupingSearch objects only support single-valued strings, and won’t find zero-valued facets. Lupyne also supports grouping hits by an arbitrary function after the original search. Similar to sorting, the native approach is generally more efficient, proportional to the number of documents culled.</p>
<p>Lupyne can also compute facet counts with intersected queries. Although seemingly less efficient, it may be faster with small numbers of terms. It also has no limitations on multiple values, and can be fully customized without reindexing.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">colors</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span>
<span class="n">facets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
<span class="n">indexer</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">Indexer</span><span class="p">()</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">Field</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">stored</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">docValuesType</span><span class="o">=</span><span class="s1">&#39;sorted&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">facets</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">facets</span><span class="p">[</span><span class="n">color</span><span class="p">]):</span>
        <span class="n">indexer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">query</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">Query</span><span class="o">.</span><span class="n">alldocs</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Groupby using GroupingSearch.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">indexer</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">facets</span><span class="p">[</span><span class="n">hits</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">==</span> <span class="n">hits</span><span class="o">.</span><span class="n">count</span>
    <span class="n">hit</span><span class="p">,</span> <span class="o">=</span> <span class="n">hits</span>
    <span class="k">assert</span> <span class="n">hit</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hits</span><span class="o">.</span><span class="n">value</span>
</pre></div>
</div>
</div>
<p>Groupby using Hits.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hits</span> <span class="o">=</span> <span class="n">indexer</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">hits</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">hits</span><span class="o">.</span><span class="n">docvalues</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">,</span> <span class="n">docs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">facets</span><span class="p">[</span><span class="n">hits</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">==</span> <span class="n">hits</span><span class="o">.</span><span class="n">count</span>
    <span class="n">hit</span><span class="p">,</span> <span class="o">=</span> <span class="n">hits</span>
    <span class="k">assert</span> <span class="n">hit</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hits</span><span class="o">.</span><span class="n">value</span>
</pre></div>
</div>
</div>
<p>Facets using GroupingSearch.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">indexer</span><span class="o">.</span><span class="n">facets</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>{&#39;color&#39;: {&#39;red&#39;: 1,
  &#39;green&#39;: 2,
  &#39;blue&#39;: 3,
  &#39;cyan&#39;: 4,
  &#39;magenta&#39;: 5,
  &#39;yellow&#39;: 6}}
</pre></div>
</div>
</div>
<p>Facets using query counts.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">queries</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;additive&#39;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">Query</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[:</span><span class="mi">3</span><span class="p">]),</span> <span class="s1">&#39;subtractive&#39;</span><span class="p">:</span> <span class="n">engine</span><span class="o">.</span><span class="n">Query</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">3</span><span class="p">:])}</span>
<span class="n">indexer</span><span class="o">.</span><span class="n">facets</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">queries</span><span class="p">)[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>{&#39;additive&#39;: 6, &#39;subtractive&#39;: 15}
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="server.html" class="btn btn-neutral float-left" title="server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Aric Coady

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>